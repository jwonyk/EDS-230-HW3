---
title: "Assignment 3: Almond Model"
subtitle: "EDS 230 - Modeling Environmental Systems"
author: "Leela Dixit, Jay Kim, Richard Montes Lemus"
date: "January 22, 2026"
format: html
editor_options: 
  chunk_output_type: console
---

**GitHub Repository:** https://github.com/jwonyk/EDS-230-HW3

# Introduction

Much of climate change research has focused on major annual crops, with less emphasis on perennial crops of agricultural importance. Lobell et al. (2006) developed a sophisticated model to assess the effects of climate change on California perennial crop yields, looking at 6 major crops: wine grapes, almonds, table grapes, oranges, walnuts, and avocados. This model takes into account climate parameters (Minimum and maximum temperatures, precipitation), but does not include factors such as CO2 and farmer responses, and is meant to provide a baseline expected response to temperature and precipitation change.

This project will reproduce the model for projected almond yield under possible climate change conditions.

### Conceptual Model

![](images/almond_conceptual_model.png)

### Step 1: Load Libraries

```{r}
#| message: false
#| warning: false 
# Load packages used throughout the workflow
library(tidyverse)
library(here)
library(knitr)
library(kableExtra)
```

### Step 2: Load Climate Data

```{r}
# Read the daily climate time series
climate <- read.table(here("Data", "clim.txt"), header = TRUE)
```

### Step 3: Clean and Prepare Climate Data for Analysis

We want to isolate the minimum temperature values in February and calculate the total precipitation for January. These are values specified in the paper specifically for almond yield.

```{r}
# This model only pulls minimum temperature from February
tmin_feb <- climate %>% 
  group_by(year) %>% 
  filter(month == 2) %>% 
  summarize(tmin_c = min(tmin_c)) %>% 
  pull(tmin_c)

# This model only pulls precipitation from January
precip_jan <- climate %>% 
  group_by(year) %>% 
  filter(month == 1) %>% 
  summarize(precip = sum(precip)) %>% 
  pull(precip)
```

### Step 4: Build Model

We can begin building our model! We will write a function that calculates almond yield based on climate parameters and will return a vector of estimated yields.

We will source our model from a separate R file that includes the model itself and associated documentation.

```{r}
# Source the model function stored in a separate R script
source(here("R", "almond_yield.R"))
```

To ensure our model is written properly, we can run a simple test with 0 values and expect a value of 0.28.

```{r}
# Quick sanity check
test <- almond_yield(0, 0)
paste0("Does our model pass the 0 sensitivity test? ", 
       test == 0.28)
```

### Step 5: Run Model

Now that we have passed the test, we can run our model using our climate vectors and check our results against the expected values.

-   Maximum = 1920 tons/acre
-   Minimum = -0.027 tons/acre
-   Mean = 182 tons/acre

```{r}
# Run the almond model on annual predictor vectors
model <- almond_yield(tmin_feb = tmin_feb, 
                      precip_jan = precip_jan)

```

```{r}
#| code-fold: true
# Create summary table outputs for the report
summary_stats <- data.frame(
  Metric = c("Maximum Annual Yield Anomaly", 
             "Minimum Annual Yield Anomaly", 
             "Mean Annual Yield Anomaly"),
  "Yield Annual Anomaly (Ton/Acre)" = 
    c(round(max(model), 0),
      round(min(model), 3),
      round(mean(model), 0)),
  check.names = FALSE)

# Print the summary
kable(summary_stats,
      caption = "Modeled Annual Almond Yield Anomaly",
      col.names = c("Metric", "Yield anomaly (ton/acre)"),
      align = "c",
      format = "html") %>% 
  kable_styling(bootstrap_options = c("striped",
                                      "condensed"),
                full_width = FALSE,
                font_size = 14) %>% 
  row_spec(0, bold = TRUE) %>% 
  row_spec(1, background = "#E3F2FD") %>% 
  row_spec(3, background = "#E3F2FD")

```
